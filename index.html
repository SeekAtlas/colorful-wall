<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½»å£°å›å»Š Â· å¯è¯„è®ºç‰ˆ</title>
    <style>
        /* === æŸ”å’Œèˆ’é€‚ä¸»é¢˜ Â· æŠ¤çœ¼ä½é¥±å’Œ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: #f4f0ea;  /* æš–ç°åº• */
            min-height: 100vh;
            padding: 2rem 1.2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-wrapper {
            max-width: 880px;
            width: 100%;
            background: #fffcf8;
            border-radius: 36px 36px 28px 28px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.04), 0 2px 8px rgba(0, 0, 0, 0.02);
            padding: 2rem 2rem;
            border: 1px solid #f0e7dd;
        }
        .wall-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .wall-header h1 {
            font-size: 2.2rem;
            font-weight: 540;
            color: #4d443b;
            letter-spacing: 2px;
            border-bottom: 2px solid #e8d9ce;
            display: inline-block;
            padding-bottom: 0.3rem;
            padding-inline: 1.2rem;
        }
        .wall-header p {
            color: #9a8b7f;
            font-size: 1rem;
            margin-top: 0.3rem;
        }

        /* å®¹é‡æ¡ â€“ æŸ”å’Œå¤§åœ°è‰² */
        .capacity-text {
            display: flex;
            justify-content: flex-end;
            color: #7f6e60;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }
        .capacity-bar {
            background: #e8ddd2;
            border-radius: 30px;
            height: 14px;
            margin: 10px 0 25px;
            overflow: hidden;
            box-shadow: inset 0 1px 4px #cdbcae;
        }
        .capacity-fill {
            height: 100%;
            background: #c9b2a0;
            width: 0%;
            border-radius: 30px;
            transition: width 0.2s;
        }

        /* è¡¨å• â€“ åœ†æ¶¦æ¸©å’Œ */
        .message-form {
            background: #fefcf9;
            border-radius: 32px;
            padding: 1.8rem 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e5d7cc;
            box-shadow: 0 6px 0 #ddd0c4;
        }
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-bottom: 1.2rem;
        }
        .input-row label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #9b897b;
            letter-spacing: 0.5px;
            margin-left: 0.5rem;
        }
        .input-row input, .input-row textarea {
            background: #fffaf5;
            border: 1.5px solid #ecdacf;
            border-radius: 28px;
            padding: 0.8rem 1.4rem;
            font-size: 0.95rem;
            outline: none;
            transition: 0.1s;
            color: #2d2a27;
        }
        .input-row input:focus, .input-row textarea:focus {
            border-color: #cfb9aa;
            background: white;
        }
        .input-row textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* é¢œè‰²é€‰æ‹© â€“ æ¸©å’Œç‚¹ç¼€ */
        .color-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            background: #fcf6f0;
            padding: 0.7rem 1.2rem;
            border-radius: 40px;
            margin-bottom: 1.2rem;
        }
        .color-row label {
            font-size: 0.9rem;
            color: #8b7a6b;
        }
        #colorPicker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            background: #cfb6a5;
            box-shadow: 0 0 0 1px #cfb9aa;
            cursor: pointer;
        }
        .preset-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .preset {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #bba28e;
            cursor: pointer;
            transition: 0.1s;
        }
        .preset:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #b3927c;
        }

        /* ä¸»æŒ‰é’® */
        .submit-btn {
            background: #ccb8a8;
            border: none;
            border-radius: 50px;
            padding: 0.9rem 2rem;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            border-bottom: 4px solid #a58e7c;
            transition: 0.05s linear;
        }
        .submit-btn:hover {
            background: #d6c2b2;
            transform: translateY(-2px);
            border-bottom-width: 4px;
        }
        .submit-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }
        .submit-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
            background: #c5b5a8;
            border-bottom-color: #9f8e80;
        }

        .message-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .count-badge {
            background: #ede3da;
            padding: 0.4rem 1.2rem;
            border-radius: 30px;
            font-size: 0.9rem;
            color: #5f5246;
        }
        /* ç®€æ´æ— å…¨å±€åˆ é™¤ */

        /* ç•™è¨€å¡ç‰‡åŒºåŸŸ */
        .message-grid {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        /* ä¸»ç•™è¨€å¡ç‰‡ */
        .message-item {
            background: white;
            border-radius: 28px 28px 28px 12px;
            padding: 1.2rem 1.5rem 0.8rem 1.5rem;
            border-left: 8px solid #d9c2b0; /* åŠ¨æ€é¢œè‰² */
            box-shadow: 0 6px 0 #e1d3c8, 0 2px 12px rgba(140, 110, 80, 0.06);
            transition: 0.1s;
        }
        .message-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-bottom: 0.4rem;
        }
        .message-name {
            font-weight: 700;
            color: #5f4e40;
            background: #f7efe8;
            padding: 0.2rem 1rem;
            border-radius: 30px;
            font-size: 0.95rem;
            border: 1px solid #eedaca;
        }
        .message-time {
            font-size: 0.7rem;
            color: #aa9a8b;
        }
        .message-text {
            font-size: 1.05rem;
            line-height: 1.5;
            color: #302b27;
            margin: 0.4rem 0 0.6rem 0;
            white-space: pre-wrap;
            word-break: break-word;
            padding-left: 0.2rem;
        }

        /* è¯„è®ºåŒº */
        .comment-section {
            margin-top: 0.8rem;
            padding-left: 0.8rem;
            border-left: 3px solid #edd9cb;
        }
        .comment-item {
            background: #f9f4ef;
            border-radius: 20px 20px 20px 6px;
            padding: 0.6rem 1.2rem;
            margin-bottom: 0.6rem;
            border-left: 5px solid #cfb9aa; /* è¯„è®ºçš„å·¦è¾¹æ¡†é¢œè‰²å–è‡ªçˆ¶ç•™è¨€ */
            font-size: 0.95rem;
        }
        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-bottom: 0.15rem;
        }
        .comment-name {
            font-weight: 600;
            color: #6b5b4e;
            font-size: 0.85rem;
            background: #efe4db;
            padding: 0.1rem 0.8rem;
            border-radius: 30px;
        }
        .comment-time {
            font-size: 0.65rem;
            color: #ad9f93;
        }
        .comment-text {
            color: #3d352f;
            margin: 0.2rem 0 0.2rem 0;
            line-height: 1.4;
            word-break: break-word;
        }

        /* å›å¤æŒ‰é’®ä¸è¾“å…¥åŒº */
        .reply-action {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.3rem;
            margin-bottom: 0.3rem;
        }
        .reply-toggle {
            background: none;
            border: 1px solid #dccfc4;
            color: #7b6b5e;
            font-size: 0.75rem;
            padding: 0.2rem 1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.1s;
        }
        .reply-toggle:hover {
            background: #ece1d7;
            border-color: #b29e8e;
        }
        .reply-form {
            margin-top: 0.8rem;
            margin-bottom: 0.3rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: #fcf7f2;
            padding: 0.8rem 1rem;
            border-radius: 24px;
        }
        .reply-input {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .reply-input input {
            flex: 1;
            min-width: 140px;
            background: white;
            border: 1px solid #e2d3c8;
            border-radius: 30px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        .reply-input input:focus {
            border-color: #c9b2a0;
            outline: none;
        }
        .reply-submit {
            background: #c9b2a0;
            border: none;
            border-radius: 30px;
            padding: 0.5rem 1.2rem;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 3px solid #9f8a7a;
        }
        .reply-submit:hover {
            background: #d5bfad;
        }
        .reply-submit:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        .cancel-reply {
            background: transparent;
            border: 1px solid #cbb7a8;
            color: #8b7869;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            background: #faf5f0;
            border-radius: 48px;
            color: #ac9a8a;
            border: 2px dashed #e0cfc0;
        }

        .footer-note {
            margin-top: 2.5rem;
            color: #aa9a8b;
            text-align: center;
            font-size: 0.75rem;
            border-top: 1px solid #ebddcf;
            padding-top: 1.5rem;
        }
        .anonymous {
            color: #a28f80;
            font-style: italic;
        }
    </style>
    <!-- å¼•å…¥Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="main-wrapper">
        <div class="wall-header">
            <h1>ğŸ“® è½»å£°å›å»Š</h1>
            <p>æ¯äººç•™è¯ Â· ä¹Ÿå¯å›åº”ä»–äºº</p>
        </div>

        <!-- å®¹é‡æ§½ -->
        <div class="capacity-text">
            <span id="capacityUsed">0</span> / 30 æ¡ä¸»ç•™è¨€
        </div>
        <div class="capacity-bar">
            <div class="capacity-fill" id="capacityFill"></div>
        </div>

        <!-- ä¸»ç•™è¨€è¡¨å• -->
        <div class="message-form">
            <div class="input-row">
                <label>ğŸ‘¤ ä½ çš„åå­—</label>
                <input type="text" id="nameInput" placeholder="åŒ¿å" maxlength="30">
            </div>
            <div class="color-row">
                <label>ğŸ¨ ä½ çš„é¢œè‰²</label>
                <input type="color" id="colorPicker" value="#d9c2b0">
                <div class="preset-colors">
                    <div class="preset" style="background: #d9c2b0;" data-color="#d9c2b0"></div>
                    <div class="preset" style="background: #c0b7ae;" data-color="#c0b7ae"></div>
                    <div class="preset" style="background: #e3c9bc;" data-color="#e3c9bc"></div>
                    <div class="preset" style="background: #b9cfd4;" data-color="#b9cfd4"></div>
                    <div class="preset" style="background: #d7c0d0;" data-color="#d7c0d0"></div>
                </div>
            </div>
            <div class="input-row">
                <label>ğŸ“ ç•™ä¸€å¥è¯</label>
                <textarea id="messageInput" placeholder="å†™ä¸‹ä¸€å¥è¯â€¦â€¦" maxlength="280"></textarea>
            </div>
            <button class="submit-btn" id="postBtn">ğŸ“® å‘å¸ƒä¸»ç•™è¨€</button>
        </div>

        <!-- ç»Ÿè®¡ -->
        <div class="message-stat">
            <span class="count-badge" id="messageCount">0 / 30 ä¸»ç•™è¨€</span>
            <!-- æ²¡æœ‰æ¸…ç©ºæŒ‰é’®ï¼Œç¬¦åˆä¸èƒ½åˆ é™¤çš„è¦æ±‚ -->
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ï¼ˆä¸»ç•™è¨€+åµŒå¥—è¯„è®ºï¼‰ -->
        <div id="messageList" class="message-grid">
            <div class="empty-state">ğŸŒ¸ åŠ è½½ä¸­...</div>
        </div>

        <div class="footer-note">
            ğŸŒ¿ ä¸»ç•™è¨€æœ€å¤š30å¥ Â· è¯„è®ºä¸é™ Â· æ‰€æœ‰äººéƒ½å¯è§
        </div>
    </div>

    <script>
        (function() {
            // Supabase é…ç½®ï¼ˆä½¿ç”¨ä¹‹å‰å·²åˆ›å»ºçš„å¯†é’¥ï¼‰
            const SUPABASE_URL = 'https://tnwmhcddhzyeqpwkwzxz.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRud21oY2RkaHp5ZXFwd2t3enh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzQyOTgsImV4cCI6MjA4NjUxMDI5OH0.nMYL_TKYhJiMtLigfIZslFKDLLYEfdH_30SJD2H6bV0';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const MAX_MAIN_MESSAGES = 30;  // ä¸»ç•™è¨€ä¸Šé™

            // å­˜å‚¨å½“å‰å±•å¼€çš„å›å¤æ¡† (è®°å½•æ­£åœ¨å›å¤å“ªæ¡ä¸»ç•™è¨€)
            let activeReplyId = null;

            // DOM
            const messageListEl = document.getElementById('messageList');
            const messageCountEl = document.getElementById('messageCount');
            const capacityUsedEl = document.getElementById('capacityUsed');
            const capacityFillEl = document.getElementById('capacityFill');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const colorPicker = document.getElementById('colorPicker');
            const postBtn = document.getElementById('postBtn');
            const presetColors = document.querySelectorAll('.preset');

            // è½¬ä¹‰
            function escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            // è·å–æ‰€æœ‰ä¸»ç•™è¨€ï¼ˆtype = 'main'ï¼‰ä»¥åŠå®ƒä»¬çš„è¯„è®ºï¼ˆå…³è”çš„commentsï¼‰
            async function loadMessages() {
                try {
                    // 1. è·å–ä¸»ç•™è¨€ (type='main' æˆ–è€…æ²¡æœ‰typeå­—æ®µçš„æ—§æ•°æ®å…¼å®¹)
                    let { data: mainMessages, error: mainError } = await supabase
                        .from('messages')
                        .select('*')
                        .or('type.eq.main,type.is.null')  // å…¼å®¹æ—§æ•°æ®
                        .order('timestamp', { ascending: false })
                        .limit(MAX_MAIN_MESSAGES);
                    
                    if (mainError) throw mainError;

                    // 2. è·å–æ‰€æœ‰è¯„è®º (type='comment')ï¼ŒæŒ‰æ—¶é—´æ­£åºï¼ˆè®©è¯„è®ºæŒ‰æ—¶é—´ä»æ—§åˆ°æ–°æ˜¾ç¤ºï¼‰
                    const { data: allComments, error: commentError } = await supabase
                        .from('messages')
                        .select('*')
                        .eq('type', 'comment')
                        .order('timestamp', { ascending: true });  // æ­£åºå±•ç¤ºè¯„è®º

                    if (commentError) throw commentError;

                    // 3. æ„å»ºè¯„è®ºæ˜ å°„è¡¨ï¼šparent_id -> [comments]
                    const commentMap = {};
                    if (allComments) {
                        allComments.forEach(c => {
                            if (c.parent_id) {
                                if (!commentMap[c.parent_id]) commentMap[c.parent_id] = [];
                                commentMap[c.parent_id].push(c);
                            }
                        });
                    }

                    // 4. å°†è¯„è®ºæŒ‚è½½åˆ°å¯¹åº”çš„ä¸»ç•™è¨€ä¸Š
                    const mainWithComments = (mainMessages || []).map(main => ({
                        ...main,
                        comments: commentMap[main.id] || []
                    }));

                    renderMessages(mainWithComments);
                    updateCapacityUI(mainWithComments.length);
                } catch (err) {
                    console.error(err);
                    messageListEl.innerHTML = '<div class="empty-state">âš ï¸ åŠ è½½å¤±è´¥ï¼Œç¨åé‡è¯•</div>';
                }
            }

            // æ¸²æŸ“ä¸»ç•™è¨€åŠåµŒå¥—è¯„è®º
            function renderMessages(mainList) {
                if (!mainList.length) {
                    messageListEl.innerHTML = '<div class="empty-state">ğŸƒ è¿˜æ²¡æœ‰ç•™è¨€â€¦â€¦ å†™ä¸€å¥è¯å§</div>';
                    return;
                }

                let html = '';
                mainList.forEach(main => {
                    const mainId = main.id;
                    const mainName = (main.name && main.name.trim()) ? escapeHtml(main.name.trim()) : '<span class="anonymous">åŒ¿å</span>';
                    const mainText = escapeHtml(main.text || '');
                    const mainColor = (main.color && /^#[0-9A-Fa-f]{6}$/.test(main.color)) ? main.color : '#d9c2b0';
                    const mainTime = main.timestamp ? new Date(main.timestamp).toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';

                    // å¼€å§‹ä¸»å¡ç‰‡
                    html += `<div class="message-item" id="msg-${mainId}" style="border-left-color: ${mainColor};">`;
                    html += `<div class="message-header">`;
                    html += `<span class="message-name">${mainName}</span>`;
                    html += `<span class="message-time">${mainTime}</span>`;
                    html += `</div>`;
                    html += `<div class="message-text">${mainText}</div>`;

                    // è¯„è®ºåŒº
                    html += `<div class="comment-section" id="comments-${mainId}">`;
                    
                    // æ˜¾ç¤ºå·²æœ‰è¯„è®º
                    const comments = main.comments || [];
                    comments.forEach(cmt => {
                        const cmtName = (cmt.name && cmt.name.trim()) ? escapeHtml(cmt.name.trim()) : '<span class="anonymous">åŒ¿å</span>';
                        const cmtText = escapeHtml(cmt.text || '');
                        const cmtTime = cmt.timestamp ? new Date(cmt.timestamp).toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';
                        html += `<div class="comment-item" style="border-left-color: ${mainColor};">`;
                        html += `<div class="comment-header"><span class="comment-name">${cmtName}</span><span class="comment-time">${cmtTime}</span></div>`;
                        html += `<div class="comment-text">${cmtText}</div>`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`; // ç»“æŸcomment-section

                    // å›å¤æŒ‰é’®åŒºåŸŸ
                    html += `<div class="reply-action">`;
                    html += `<button class="reply-toggle" onclick="toggleReply('${mainId}')">ğŸ’¬ å›å¤</button>`;
                    html += `</div>`;

                    // å›å¤è¡¨å•ï¼ˆåŠ¨æ€éšè—/æ˜¾ç¤ºï¼Œç”±activeReplyIdæ§åˆ¶ï¼‰
                    if (activeReplyId === mainId) {
                        html += `<div class="reply-form" id="reply-form-${mainId}">`;
                        html += `<div class="reply-input">`;
                        html += `<input type="text" id="reply-name-${mainId}" placeholder="ä½ çš„åå­—" value="">`;
                        html += `<input type="text" id="reply-text-${mainId}" placeholder="å†™è¯„è®º...">`;
                        html += `</div>`;
                        html += `<div style="display: flex; gap: 0.5rem; justify-content: flex-end;">`;
                        html += `<button class="reply-submit" onclick="submitReply('${mainId}')">å‘é€</button>`;
                        html += `<button class="cancel-reply" onclick="cancelReply()">å–æ¶ˆ</button>`;
                        html += `</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`; // ç»“æŸmessage-item
                });

                messageListEl.innerHTML = html;

                // æŠŠå‡½æ•°æŒ‚è½½åˆ°windowä¸Šï¼Œä¾›onclickè°ƒç”¨
                window.toggleReply = function(mainId) {
                    activeReplyId = (activeReplyId === mainId) ? null : mainId;
                    loadMessages();  // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤º/éšè—å›å¤æ¡†
                };

                window.cancelReply = function() {
                    activeReplyId = null;
                    loadMessages();
                };

                window.submitReply = async function(mainId) {
                    const replyName = document.getElementById(`reply-name-${mainId}`)?.value.trim() || 'åŒ¿å';
                    const replyText = document.getElementById(`reply-text-${mainId}`)?.value.trim();
                    if (!replyText) {
                        alert('è¯„è®ºä¸èƒ½ä¸ºç©º');
                        return;
                    }

                    // å‘å¸ƒè¯„è®º (type = 'comment', parent_id = mainId)
                    const { error } = await supabase
                        .from('messages')
                        .insert([{
                            name: replyName,
                            text: replyText,
                            color: '#d9c2b0',      // è¯„è®ºæ²¿ç”¨ä¸»è‰²è°ƒï¼Œä¸é¢å¤–é€‰è‰²
                            timestamp: Date.now(),
                            type: 'comment',
                            parent_id: mainId
                        }]);
                    
                    if (error) {
                        alert('è¯„è®ºå¤±è´¥: ' + error.message);
                        return;
                    }

                    // å…³é—­å›å¤æ¡†ï¼Œåˆ·æ–°
                    activeReplyId = null;
                    loadMessages();
                };
            }

            // æ›´æ–°å®¹é‡æ˜¾ç¤º + æŒ‰é’®æ§åˆ¶ï¼ˆ>30ç¦ç”¨ï¼Œä½†å› ä¸ºæœ‰è§¦å‘å™¨æ°¸è¿œä¸ä¼šåˆ°31ï¼‰
            function updateCapacityUI(count) {
                capacityUsedEl.innerText = count;
                const percent = (count / MAX_MAIN_MESSAGES) * 100;
                capacityFillEl.style.width = percent + '%';
                messageCountEl.innerText = `${count} / ${MAX_MAIN_MESSAGES} ä¸»ç•™è¨€`;

                // è¶…è¿‡30æ‰ç¦ç”¨æŒ‰é’® (å®é™…ä¸Šå› ä¸ºè§¦å‘å™¨ï¼Œä¸ä¼šè¶…è¿‡30)
                postBtn.classList.toggle('disabled', count > MAX_MAIN_MESSAGES);
                postBtn.disabled = count > MAX_MAIN_MESSAGES;
            }

            // è·å–å½“å‰ä¸»ç•™è¨€æ•°é‡
            async function getMainCount() {
                const { count, error } = await supabase
                    .from('messages')
                    .select('*', { count: 'exact', head: true })
                    .or('type.eq.main,type.is.null');
                if (error) {
                    console.warn(error);
                    return 0;
                }
                return count || 0;
            }

            // å‘å¸ƒä¸»ç•™è¨€
            async function addMainMessage() {
                const currentCount = await getMainCount();
                if (currentCount >= MAX_MAIN_MESSAGES) {
                    if (!confirm('âš ï¸ ä¸»ç•™è¨€å·²è¾¾30æ¡ä¸Šé™ï¼Œå‘é€åå°†è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„ä¸€æ¡ã€‚ç¡®å®šç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                }

                const text = messageInput.value.trim();
                if (!text) {
                    alert('è¯·å†™ä¸€å¥è¯');
                    return;
                }

                const name = nameInput.value.trim() || 'åŒ¿å';
                const color = colorPicker.value;

                // æ’å…¥ä¸»ç•™è¨€ (type = 'main')
                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        name: name,
                        text: text,
                        color: color,
                        timestamp: Date.now(),
                        type: 'main',
                        parent_id: null
                    }]);
                
                if (error) {
                    alert('å‘å¸ƒå¤±è´¥: ' + error.message);
                    return;
                }

                messageInput.value = '';
                loadMessages();
            }

            // ç»‘å®šäº‹ä»¶
            postBtn.addEventListener('click', addMainMessage);
            messageInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    addMainMessage();
                }
            });
            presetColors.forEach(p => {
                p.addEventListener('click', () => {
                    colorPicker.value = p.dataset.color;
                });
            });

            // å®æ—¶è®¢é˜…ï¼ˆæœ‰æ–°æ¶ˆæ¯æˆ–è¯„è®ºå°±åˆ·æ–°ï¼‰
            supabase
                .channel('messages-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                    loadMessages();
                })
                .subscribe();

            // å¯åŠ¨
            loadMessages();
        })();
    </script>
</body>
</html>