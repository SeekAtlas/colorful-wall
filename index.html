<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>è½»å£°å›å»Š Â· å¯è¯„è®ºç‰ˆ</title>
    <style>
        /* === æŸ”å’Œèˆ’é€‚ä¸»é¢˜ Â· æŠ¤çœ¼ä½é¥±å’Œ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        body {
            background: #f4f0ea;
            min-height: 100vh;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-wrapper {
            max-width: 880px;
            width: 100%;
            background: #fffcf8;
            border-radius: 36px 36px 28px 28px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.04);
            padding: 1.5rem 1.5rem;
            border: 1px solid #f0e7dd;
        }
        .wall-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .wall-header h1 {
            font-size: 2rem;
            font-weight: 540;
            color: #4d443b;
            letter-spacing: 2px;
            border-bottom: 2px solid #e8d9ce;
            display: inline-block;
            padding-bottom: 0.3rem;
            padding-inline: 1rem;
        }
        .wall-header p {
            color: #9a8b7f;
            font-size: 0.95rem;
            margin-top: 0.3rem;
        }

        /* å®¹é‡æ¡ */
        .capacity-text {
            display: flex;
            justify-content: flex-end;
            color: #7f6e60;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        .capacity-bar {
            background: #e8ddd2;
            border-radius: 30px;
            height: 12px;
            margin: 5px 0 20px;
            overflow: hidden;
            box-shadow: inset 0 1px 4px #cdbcae;
        }
        .capacity-fill {
            height: 100%;
            background: #c9b2a0;
            width: 0%;
            border-radius: 30px;
            transition: width 0.2s;
        }

        /* è¡¨å• */
        .message-form {
            background: #fefcf9;
            border-radius: 28px;
            padding: 1.4rem 1.5rem;
            margin-bottom: 1.8rem;
            border: 1px solid #e5d7cc;
            box-shadow: 0 5px 0 #ddd0c4;
        }
        .input-row {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            margin-bottom: 1rem;
        }
        .input-row label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9b897b;
            letter-spacing: 0.5px;
            margin-left: 0.5rem;
        }
        .input-row input, .input-row textarea {
            background: #fffaf5;
            border: 1.5px solid #ecdacf;
            border-radius: 24px;
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            outline: none;
            width: 100%;
        }
        .input-row input:focus, .input-row textarea:focus {
            border-color: #cfb9aa;
        }
        .input-row textarea {
            min-height: 70px;
            resize: vertical;
        }

        /* é¢œè‰²é€‰æ‹© */
        .color-row {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
            background: #fcf6f0;
            padding: 0.6rem 1rem;
            border-radius: 40px;
            margin-bottom: 1rem;
        }
        .color-row label {
            font-size: 0.85rem;
            color: #8b7a6b;
        }
        #colorPicker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid white;
            background: #cfb6a5;
            box-shadow: 0 0 0 1px #cfb9aa;
            cursor: pointer;
        }
        .preset-colors {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .preset {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #bba28e;
            cursor: pointer;
        }

        /* ä¸»æŒ‰é’® */
        .submit-btn {
            background: #ccb8a8;
            border: none;
            border-radius: 40px;
            padding: 0.8rem 1.5rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 2px;
            cursor: pointer;
            width: 100%;
            border-bottom: 4px solid #a58e7c;
        }
        .submit-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .submit-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .message-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }
        .count-badge {
            background: #ede3da;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.85rem;
            color: #5f5246;
        }

        /* ç•™è¨€å¡ç‰‡ */
        .message-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message-item {
            background: white;
            border-radius: 24px 24px 24px 10px;
            padding: 1rem 1.2rem 0.8rem;
            border-left: 8px solid #d9c2b0;
            box-shadow: 0 4px 0 #e1d3c8;
        }
        .message-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-bottom: 0.3rem;
        }
        .message-name {
            font-weight: 700;
            color: #5f4e40;
            background: #f7efe8;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
            font-size: 0.9rem;
            border: 1px solid #eedaca;
        }
        .message-time {
            font-size: 0.65rem;
            color: #aa9a8b;
        }
        .message-text {
            font-size: 1rem;
            line-height: 1.4;
            color: #302b27;
            margin: 0.3rem 0 0.5rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* è¯„è®ºåŒº */
        .comment-section {
            margin-top: 0.6rem;
            padding-left: 0.6rem;
            border-left: 3px solid #edd9cb;
        }
        .comment-item {
            background: #f9f4ef;
            border-radius: 16px 16px 16px 4px;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-left: 5px solid #cfb9aa;
            font-size: 0.9rem;
        }
        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.1rem;
        }
        .comment-name {
            font-weight: 600;
            color: #6b5b4e;
            font-size: 0.8rem;
            background: #efe4db;
            padding: 0.1rem 0.6rem;
            border-radius: 30px;
        }
        .comment-time {
            font-size: 0.6rem;
            color: #ad9f93;
        }
        .comment-text {
            color: #3d352f;
            margin: 0.1rem 0;
            line-height: 1.3;
        }

        /* å›å¤æŒ‰é’® */
        .reply-action {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.3rem;
        }
        .reply-toggle {
            background: none;
            border: 1px solid #dccfc4;
            color: #7b6b5e;
            font-size: 0.7rem;
            padding: 0.2rem 0.8rem;
            border-radius: 30px;
            cursor: pointer;
        }
        .reply-toggle:active {
            background: #ece1d7;
        }

        /* å›å¤è¡¨å• */
        .reply-form {
            margin-top: 0.6rem;
            margin-bottom: 0.3rem;
            background: #fcf7f2;
            padding: 0.8rem;
            border-radius: 20px;
        }
        .reply-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .reply-input input {
            background: white;
            border: 1px solid #e2d3c8;
            border-radius: 30px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            width: 100%;
        }
        .reply-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        .reply-submit {
            background: #c9b2a0;
            border: none;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 3px solid #9f8a7a;
        }
        .cancel-reply {
            background: transparent;
            border: 1px solid #cbb7a8;
            color: #8b7869;
            border-radius: 30px;
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 2.5rem 1rem;
            background: #faf5f0;
            border-radius: 40px;
            color: #ac9a8a;
            border: 2px dashed #e0cfc0;
        }

        .footer-note {
            margin-top: 2rem;
            color: #aa9a8b;
            text-align: center;
            font-size: 0.7rem;
            border-top: 1px solid #ebddcf;
            padding-top: 1.2rem;
        }
        .anonymous {
            color: #a28f80;
            font-style: italic;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="main-wrapper">
        <div class="wall-header">
            <h1>ğŸ“® è½»å£°å›å»Š</h1>
            <p>æ¯äººç•™è¯ Â· ä¹Ÿå¯å›åº”ä»–äºº</p>
        </div>

        <div class="capacity-text">
            <span id="capacityUsed">0</span> / 30 æ¡ä¸»ç•™è¨€
        </div>
        <div class="capacity-bar">
            <div class="capacity-fill" id="capacityFill"></div>
        </div>

        <div class="message-form">
            <div class="input-row">
                <label>ğŸ‘¤ ä½ çš„åå­—</label>
                <input type="text" id="nameInput" placeholder="åŒ¿å" maxlength="30">
            </div>
            <div class="color-row">
                <label>ğŸ¨ ä½ çš„é¢œè‰²</label>
                <input type="color" id="colorPicker" value="#d9c2b0">
                <div class="preset-colors">
                    <div class="preset" style="background: #d9c2b0;" data-color="#d9c2b0"></div>
                    <div class="preset" style="background: #c0b7ae;" data-color="#c0b7ae"></div>
                    <div class="preset" style="background: #e3c9bc;" data-color="#e3c9bc"></div>
                    <div class="preset" style="background: #b9cfd4;" data-color="#b9cfd4"></div>
                    <div class="preset" style="background: #d7c0d0;" data-color="#d7c0d0"></div>
                </div>
            </div>
            <div class="input-row">
                <label>ğŸ“ ç•™ä¸€å¥è¯</label>
                <textarea id="messageInput" placeholder="å†™ä¸‹ä¸€å¥è¯â€¦â€¦" maxlength="280"></textarea>
            </div>
            <button class="submit-btn" id="postBtn">ğŸ“® å‘å¸ƒä¸»ç•™è¨€</button>
        </div>

        <div class="message-stat">
            <span class="count-badge" id="messageCount">0 / 30 ä¸»ç•™è¨€</span>
        </div>

        <div id="messageList" class="message-grid">
            <div class="empty-state">ğŸŒ¸ åŠ è½½ä¸­...</div>
        </div>

        <div class="footer-note">
            ğŸŒ¿ ä¸»ç•™è¨€æœ€å¤š30å¥ Â· è¯„è®ºä¸é™ Â· æ‰€æœ‰äººéƒ½å¯è§
        </div>
    </div>

    <script>
        (function() {
            const SUPABASE_URL = 'https://tnwmhcddhzyeqpwkwzxz.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRud21oY2RkaHp5ZXFwd2t3enh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzQyOTgsImV4cCI6MjA4NjUxMDI5OH0.nMYL_TKYhJiMtLigfIZslFKDLLYEfdH_30SJD2H6bV0';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const MAX_MAIN_MESSAGES = 30;
            
            let activeReplyId = null;

            const messageListEl = document.getElementById('messageList');
            const messageCountEl = document.getElementById('messageCount');
            const capacityUsedEl = document.getElementById('capacityUsed');
            const capacityFillEl = document.getElementById('capacityFill');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const colorPicker = document.getElementById('colorPicker');
            const postBtn = document.getElementById('postBtn');
            const presetColors = document.querySelectorAll('.preset');

            function escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            async function loadMessages() {
                try {
                    const { data: mainMessages, error: mainError } = await supabase
                        .from('messages')
                        .select('*')
                        .or('type.eq.main,type.is.null')
                        .order('timestamp', { ascending: false })
                        .limit(MAX_MAIN_MESSAGES);
                    
                    if (mainError) throw mainError;

                    const { data: allComments, error: commentError } = await supabase
                        .from('messages')
                        .select('*')
                        .eq('type', 'comment')
                        .order('timestamp', { ascending: true });

                    if (commentError) throw commentError;

                    const commentMap = {};
                    if (allComments) {
                        allComments.forEach(c => {
                            if (c.parent_id) {
                                if (!commentMap[c.parent_id]) commentMap[c.parent_id] = [];
                                commentMap[c.parent_id].push(c);
                            }
                        });
                    }

                    const mainWithComments = (mainMessages || []).map(main => ({
                        ...main,
                        comments: commentMap[main.id] || []
                    }));

                    renderMessages(mainWithComments);
                    updateCapacityUI(mainWithComments.length);
                } catch (err) {
                    console.error(err);
                    messageListEl.innerHTML = '<div class="empty-state">âš ï¸ åŠ è½½å¤±è´¥ï¼Œç¨åé‡è¯•</div>';
                }
            }

            function renderMessages(mainList) {
                if (!mainList.length) {
                    messageListEl.innerHTML = '<div class="empty-state">ğŸƒ è¿˜æ²¡æœ‰ç•™è¨€â€¦â€¦ å†™ä¸€å¥è¯å§</div>';
                    return;
                }

                let html = '';
                mainList.forEach(main => {
                    const mainId = main.id;
                    const mainName = (main.name && main.name.trim()) ? escapeHtml(main.name.trim()) : '<span class="anonymous">åŒ¿å</span>';
                    const mainText = escapeHtml(main.text || '');
                    const mainColor = (main.color && /^#[0-9A-Fa-f]{6}$/.test(main.color)) ? main.color : '#d9c2b0';
                    const mainTime = main.timestamp ? new Date(main.timestamp).toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';

                    html += `<div class="message-item" data-message-id="${mainId}" style="border-left-color: ${mainColor};">`;
                    html += `<div class="message-header">`;
                    html += `<span class="message-name">${mainName}</span>`;
                    html += `<span class="message-time">${mainTime}</span>`;
                    html += `</div>`;
                    html += `<div class="message-text">${mainText}</div>`;

                    html += `<div class="comment-section" id="comments-${mainId}">`;
                    
                    (main.comments || []).forEach(cmt => {
                        const cmtName = (cmt.name && cmt.name.trim()) ? escapeHtml(cmt.name.trim()) : '<span class="anonymous">åŒ¿å</span>';
                        const cmtText = escapeHtml(cmt.text || '');
                        const cmtTime = cmt.timestamp ? new Date(cmt.timestamp).toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) : '';
                        html += `<div class="comment-item" style="border-left-color: ${mainColor};">`;
                        html += `<div class="comment-header"><span class="comment-name">${cmtName}</span><span class="comment-time">${cmtTime}</span></div>`;
                        html += `<div class="comment-text">${cmtText}</div>`;
                        html += `</div>`;
                    });
                    
                    html += `</div>`;

                    html += `<div class="reply-action">`;
                    html += `<button class="reply-toggle" data-message-id="${mainId}">ğŸ’¬ å›å¤</button>`;
                    html += `</div>`;

                    if (activeReplyId === mainId) {
                        html += `<div class="reply-form" id="reply-form-${mainId}">`;
                        html += `<div class="reply-input">`;
                        html += `<input type="text" id="reply-name-${mainId}" placeholder="ä½ çš„åå­—" value="">`;
                        html += `<input type="text" id="reply-text-${mainId}" placeholder="å†™è¯„è®º...">`;
                        html += `</div>`;
                        html += `<div class="reply-buttons">`;
                        html += `<button class="reply-submit" data-message-id="${mainId}">å‘é€</button>`;
                        html += `<button class="cancel-reply" data-message-id="${mainId}">å–æ¶ˆ</button>`;
                        html += `</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                });

                messageListEl.innerHTML = html;
            }

            function updateCapacityUI(count) {
                capacityUsedEl.innerText = count;
                const percent = (count / MAX_MAIN_MESSAGES) * 100;
                capacityFillEl.style.width = percent + '%';
                messageCountEl.innerText = `${count} / ${MAX_MAIN_MESSAGES} ä¸»ç•™è¨€`;
                postBtn.classList.toggle('disabled', count > MAX_MAIN_MESSAGES);
                postBtn.disabled = count > MAX_MAIN_MESSAGES;
            }

            async function getMainCount() {
                const { count, error } = await supabase
                    .from('messages')
                    .select('*', { count: 'exact', head: true })
                    .or('type.eq.main,type.is.null');
                return count || 0;
            }

            async function addMainMessage() {
                const currentCount = await getMainCount();
                if (currentCount >= MAX_MAIN_MESSAGES) {
                    if (!confirm('âš ï¸ ä¸»ç•™è¨€å·²è¾¾30æ¡ä¸Šé™ï¼Œå‘é€åå°†è‡ªåŠ¨åˆ é™¤æœ€æ—§çš„ä¸€æ¡ã€‚ç¡®å®šç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                }

                const text = messageInput.value.trim();
                if (!text) {
                    alert('è¯·å†™ä¸€å¥è¯');
                    return;
                }

                const name = nameInput.value.trim() || 'åŒ¿å';
                const color = colorPicker.value;

                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        name: name,
                        text: text,
                        color: color,
                        timestamp: Date.now(),
                        type: 'main',
                        parent_id: null
                    }]);
                
                if (error) {
                    alert('å‘å¸ƒå¤±è´¥: ' + error.message);
                    return;
                }

                messageInput.value = '';
                loadMessages();
            }

            async function addComment(mainId) {
                const replyName = document.getElementById(`reply-name-${mainId}`)?.value.trim() || 'åŒ¿å';
                const replyText = document.getElementById(`reply-text-${mainId}`)?.value.trim();
                
                if (!replyText) {
                    alert('è¯„è®ºä¸èƒ½ä¸ºç©º');
                    return;
                }

                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        name: replyName,
                        text: replyText,
                        color: '#d9c2b0',
                        timestamp: Date.now(),
                        type: 'comment',
                        parent_id: mainId
                    }]);
                
                if (error) {
                    alert('è¯„è®ºå¤±è´¥: ' + error.message);
                    return;
                }

                activeReplyId = null;
                loadMessages();
            }

            // äº‹ä»¶ç›‘å¬ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            messageListEl.addEventListener('click', (e) => {
                const target = e.target;
                
                // å›å¤æŒ‰é’®
                if (target.classList.contains('reply-toggle')) {
                    const messageId = target.dataset.messageId;
                    activeReplyId = activeReplyId === messageId ? null : messageId;
                    loadMessages();
                }
                
                // å–æ¶ˆæŒ‰é’®
                if (target.classList.contains('cancel-reply')) {
                    activeReplyId = null;
                    loadMessages();
                }
                
                // å‘é€æŒ‰é’®
                if (target.classList.contains('reply-submit')) {
                    const messageId = target.dataset.messageId;
                    addComment(messageId);
                }
            });

            // ä¸»ç•™è¨€å‘å¸ƒ
            postBtn.addEventListener('click', addMainMessage);
            
            // Ctrl+Enter å‘é€
            messageInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    addMainMessage();
                }
            });

            // é¢„è®¾é¢œè‰²
            presetColors.forEach(p => {
                p.addEventListener('click', () => {
                    colorPicker.value = p.dataset.color;
                });
            });

            // å®æ—¶è®¢é˜…
            supabase
                .channel('messages-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
                    loadMessages();
                })
                .subscribe();

            // å¯åŠ¨
            loadMessages();
        })();
    </script>
</body>
</html>