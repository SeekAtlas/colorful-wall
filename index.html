<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯äººç•™ä¸€å¥è¯ Â· å…¨çƒå…±äº«ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: linear-gradient(165deg, #fef9f0 0%, #fff3e2 100%); min-height: 100vh; padding: 2rem 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .main-wrapper { max-width: 820px; width: 100%; background: rgba(255,255,250,0.7); backdrop-filter: blur(4px); border-radius: 48px; padding: 2.4rem 2.2rem; border: 1px solid #fffef7; }
        .wall-header { text-align: center; margin-bottom: 2rem; }
        .wall-header h1 { font-size: 2.4rem; color: #4f3e32; text-shadow: 3px 3px 0 #ffefd2; }
        .capacity-text { display: flex; justify-content: flex-end; color: #7d6553; margin-bottom: 5px; }
        .capacity-bar { background: #efded0; border-radius: 60px; height: 16px; margin: 15px 0 20px; overflow: hidden; }
        .capacity-fill { height: 16px; background: linear-gradient(90deg, #d9b596, #c4a07e); width: 0%; transition: width 0.25s ease; }
        .message-form { background: #ffffffdd; border-radius: 40px; padding: 1.8rem 2rem; margin-bottom: 2rem; box-shadow: 0 8px 0 #ddcfbf; }
        .input-row { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1.3rem; }
        .input-row label { font-size: 0.85rem; font-weight: 600; color: #826e5d; }
        .input-row input, .input-row textarea { background: #fffbf7; border: 2px solid #f1e0d1; border-radius: 28px; padding: 0.9rem 1.5rem; font-size: 1rem; outline: none; }
        .input-row textarea { min-height: 100px; }
        .color-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; background: #fffaf2; padding: 0.8rem 1.2rem; border-radius: 60px; margin-bottom: 1.4rem; }
        #colorPicker { width: 48px; height: 48px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        .preset-colors { display: flex; gap: 10px; flex-wrap: wrap; }
        .preset { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        .submit-btn { background: #b8a085; border: none; padding: 1rem 2rem; border-radius: 60px; color: white; font-size: 1.25rem; font-weight: 600; cursor: pointer; border-bottom: 5px solid #927b66; width: 100%; }
        .submit-btn:hover { background: #c9b3a0; transform: translateY(2px); }
        .submit-btn.disabled { opacity: 0.55; cursor: not-allowed; }
        .message-stat { display: flex; justify-content: flex-end; margin-bottom: 1.5rem; }
        .count-badge { background: #ede3d8; padding: 0.5rem 1.3rem; border-radius: 50px; font-size: 1rem; color: #5f4e3e; }
        .message-grid { display: flex; flex-direction: column; gap: 1.2rem; }
        .message-item { background: white; padding: 1.5rem 1.9rem; border-radius: 36px; border-left: 14px solid #dbbd9f; box-shadow: 0 8px 0 #cfbba9; }
        .message-name { font-weight: 700; color: #4b3d31; display: inline-block; background: #fff7ef; padding: 0.2rem 1.2rem; border-radius: 50px; margin-bottom: 0.7rem; }
        .message-text { font-size: 1.2rem; color: #2b2723; margin-bottom: 0.6rem; white-space: pre-wrap; }
        .message-footer { display: flex; justify-content: flex-end; color: #9a8777; font-size: 0.8rem; border-top: 1px dashed #ead5c2; padding-top: 0.7rem; }
        .empty-state { text-align: center; padding: 3rem; background: #fffbf5; border-radius: 60px; color: #a6907c; border: 2px dashed #e8d3bd; }
        .footer-note { margin-top: 2.5rem; color: #a18e7d; text-align: center; font-size: 0.8rem; border-top: 1px solid #f0ddcc; padding-top: 1.5rem; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="main-wrapper">
        <div class="wall-header">
            <h1>ğŸŒ è‰²Â·å»Š Â· å…¨çƒç‰ˆ</h1>
            <p>æ¯äººç•™ä¸€å¥è¯ Â· å…¨ä¸–ç•Œéƒ½èƒ½çœ‹è§</p>
        </div>

        <div class="capacity-text">
            <span id="capacityUsed">0</span> / 30 å¥
        </div>
        <div class="capacity-bar">
            <div class="capacity-fill" id="capacityFill"></div>
        </div>

        <div class="message-form">
            <div class="input-row">
                <label>ä½ çš„åå­—</label>
                <input type="text" id="nameInput" placeholder="åŒ¿åä¹Ÿæ¬¢è¿" maxlength="30">
            </div>
            
            <div class="color-row">
                <label>ğŸ¨ é¢œè‰²</label>
                <input type="color" id="colorPicker" value="#c49a7b">
                <div class="preset-colors">
                    <div class="preset" style="background: #f0b27a;" data-color="#f0b27a"></div>
                    <div class="preset" style="background: #b5c9b0;" data-color="#b5c9b0"></div>
                    <div class="preset" style="background: #e9b5b5;" data-color="#e9b5b5"></div>
                    <div class="preset" style="background: #b2c4d9;" data-color="#b2c4d9"></div>
                    <div class="preset" style="background: #e6c8a0;" data-color="#e6c8a0"></div>
                </div>
            </div>

            <div class="input-row">
                <label>ç•™ä¸€å¥è¯</label>
                <textarea id="messageInput" placeholder="ä½ çš„è¯ä¼šè¢«æ‰€æœ‰äººçœ‹è§" maxlength="280"></textarea>
            </div>
            <button class="submit-btn" id="postBtn">ğŸ“Œ å‘å¸ƒåˆ°å…¨ä¸–ç•Œ</button>
        </div>

        <div class="message-stat">
            <span class="count-badge" id="messageCount">0 / 30 å¥</span>
        </div>

        <div id="messageList" class="message-grid">
            <div class="empty-state">åŠ è½½ç•™è¨€ä¸­...</div>
        </div>

        <div class="footer-note">
            ğŸ’Œ å…¨çƒå…±äº« Â· æ¯äººä¸€å¥ Â· è‡ªåŠ¨ä¿ç•™æœ€æ–°30æ¡
        </div>
    </div>

    <script>
        (function() {
            const SUPABASE_URL = 'https://tnwmhcddhzyeqpwkwzxz.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRud21oY2RkaHp5ZXFwd2t3enh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzQyOTgsImV4cCI6MjA4NjUxMDI5OH0.nMYL_TKYhJiMtLigfIZslFKDLLYEfdH_30SJD2H6bV0';
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const MAX_MESSAGES = 30;
            
            // DOMå…ƒç´ 
            const messageListEl = document.getElementById('messageList');
            const messageCountEl = document.getElementById('messageCount');
            const capacityUsedEl = document.getElementById('capacityUsed');
            const capacityFillEl = document.getElementById('capacityFill');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const colorPicker = document.getElementById('colorPicker');
            const postBtn = document.getElementById('postBtn');
            const presetColors = document.querySelectorAll('.preset');

            // åŠ è½½ç•™è¨€
            async function loadMessages() {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(MAX_MESSAGES);
                
                if (error) {
                    console.error('åŠ è½½å¤±è´¥:', error);
                    messageListEl.innerHTML = '<div class="empty-state">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
                    return;
                }
                
                renderMessages(data || []);
                updateCapacityUI(data?.length || 0);
            }

            // æ¸²æŸ“ç•™è¨€
            function renderMessages(messages) {
                if (messages.length === 0) {
                    messageListEl.innerHTML = '<div class="empty-state">ğŸ•Šï¸ è¿˜æ²¡æœ‰äººç•™è¯ï¼Œæ¥åšç¬¬ä¸€ä¸ªå§ï¼</div>';
                    return;
                }

                let html = '';
                messages.forEach(msg => {
                    const name = msg.name || 'åŒ¿å';
                    const color = msg.color || '#dbbd9f';
                    const date = new Date(msg.timestamp);
                    const timeStr = `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()}`;
                    
                    html += `<div class="message-item" style="border-left-color: ${color};">
                        <div class="message-name">${escapeHtml(name)}</div>
                        <div class="message-text">${escapeHtml(msg.text)}</div>
                        <div class="message-footer"><span>ğŸ¨ ${timeStr}</span></div>
                    </div>`;
                });
                
                messageListEl.innerHTML = html;
            }

            // æ›´æ–°å®¹é‡æ˜¾ç¤º
            function updateCapacityUI(count) {
                capacityUsedEl.innerText = count;
                capacityFillEl.style.width = (count / MAX_MESSAGES * 100) + '%';
                messageCountEl.innerText = `${count} / ${MAX_MESSAGES} å¥`;
            }

            // æ·»åŠ ç•™è¨€
            async function addMessage() {
                const text = messageInput.value.trim();
                if (!text) {
                    alert('è¯·ç•™ä¸€å¥è¯');
                    return;
                }

                const name = nameInput.value.trim() || 'åŒ¿å';
                const color = colorPicker.value;

                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        name: name,
                        text: text,
                        color: color,
                        timestamp: Date.now()
                    }]);
                
                if (error) {
                    alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•');
                    console.error(error);
                    return;
                }

                messageInput.value = '';
                loadMessages();
            }

            // è½¬ä¹‰HTML
            function escapeHtml(str) {
                return str.replace(/[&<>"]/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    return m;
                });
            }

            // ç»‘å®šäº‹ä»¶
            postBtn.addEventListener('click', addMessage);
            
            messageInput.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    addMessage();
                }
            });

            presetColors.forEach(preset => {
                preset.addEventListener('click', () => {
                    colorPicker.value = preset.dataset.color;
                });
            });

            // å¯åŠ¨
            loadMessages();
        })();
    </script>
</body>
</html>